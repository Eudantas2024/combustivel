<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cálculo de Combustível</title>
  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#f4f7fb;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:10px;
      min-height:100vh;
    }

    .container{
      background:#fff;
      padding:15px;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,0.1);
      width:100%;
      max-width:600px;
      box-sizing:border-box;
    }

    h1,h2{
      text-align:center;
      margin:0 0 10px;
      font-size:1.5rem;
    }

    label{
      display:block;
      font-weight:bold;
      margin-top:8px;
      font-size:0.9rem;
    }

    input,button{
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
      font-size:16px;
      width:100%;
      box-sizing:border-box;
      margin-top:4px;
    }

    .actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:12px;
    }

    button{cursor:pointer}

    button#calcular{background:#007BFF;color:#fff;border:0}
    button#limpar{background:#eee}
    button#exportar{background:#28a745;color:#fff;border:0}
    button#importar{background:#ff9800;color:#fff;border:0}

    .resultado,.historico,.resumos{
      margin-top:15px;
    }

    .resultado p,.resumos p{
      margin:6px 0;
      font-size:16px;
    }

    .valor{font-weight:bold}
    .lucro-positivo{color:green}
    .lucro-negativo{color:red}

    /* Histórico com letra menor */
    .historico table{
      width:140%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:12px;
      word-break: break-word;
    }

    .historico th, .historico td{
      border:1px solid #ccc;
      padding:4px;
      text-align:center;
    }

    .historico th{background:#f0f0f0}

    .historico td button{
      padding:2px 4px;
      font-size:10px;
      border:none;
      border-radius:4px;
      background:#dc3545;
      color:#fff;
      cursor:pointer;
    }

    .historico td button:hover{background:#b52a36}

    /* Responsivo para telas até 600px */
    @media (max-width:600px){
      body{padding:5px;}
      .container{padding:10px;}
      h1,h2{font-size:1.3rem;}
      label{font-size:0.85rem;}
      input,button{font-size:14px;padding:8px;}
      .actions{gap:6px;margin-top:10px;}
      .resultado p,.resumos p{font-size:14px;margin:4px 0;}
      .historico table{font-size:11px;}
      .historico th,.historico td{padding:3px;}
      .historico td button{font-size:9px;padding:2px 3px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cálculo de Combustível UBER</h1>

    <form id="formCalc" novalidate>
      <div>
        <label for="litro">Litro R$</label>
        <input id="litro" type="number" step="0.01" placeholder="Ex: 3.89">
      </div>
      <div>
        <label for="kmLitro">KM por litro</label>
        <input id="kmLitro" type="number" step="0.1" placeholder="Ex: 10">
      </div>
      <div>
        <label for="kmsRodados">KMs rodados</label>
        <input id="kmsRodados" type="number" step="0.1" placeholder="Ex: 150">
      </div>
      <div>
        <label for="valorRecebido">Valor recebido R$</label>
        <input id="valorRecebido" type="number" step="0.01" placeholder="Ex: 200">
      </div>
      <div class="actions">
        <button id="calcular" type="submit">Calcular</button>
        <button id="limpar" type="button">Limpar</button>
        <button id="exportar" type="button">Exportar JSON</button>
        <button id="importar" type="button">Importar JSON</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none">
      </div>
    </form>

    <div class="resultado" id="resultado" style="display:none">
      <h2>Resultado</h2>
      <p>Custo por Km: <span class="valor" id="custoPorKm"></span></p>
      <p>Custo da Viagem: <span class="valor" id="custoViagem"></span></p>
      <p>Lucro: <span class="valor" id="lucro"></span></p>
    </div>

        <div class="resumos" id="resumos" style="display:none">
      <h2>Resumo Geral</h2>
      <p>Quantidade de Viagens: <span id="totalViagens" class="valor"></span></p>
      <p>Total Bruto: <span id="totalBruto" class="valor"></span></p>
      <p>Total Custo: <span id="totalCusto" class="valor"></span></p>
      <p>Total Lucro: <span id="totalLucro" class="valor"></span></p>
    </div>

    <div class="historico">
      <h2>Histórico</h2>
      <table id="tabelaHistorico">
        <thead>
          <tr>
            <th>Nº</th> <!-- Nova coluna -->
            <th>Data/Hora</th>
            <th>Litro (R$)</th>
            <th>KM/L</th>
            <th>KMs</th>
            <th>Recebido (R$)</th>
            <th>Custo/KM</th>
            <th>Custo Viagem</th>
            <th>Lucro</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>



  </div>

  <script>
    let db;
    const request = indexedDB.open("CombustivelDB", 1);
    request.onupgradeneeded = function(e){
      db = e.target.result;
      if(!db.objectStoreNames.contains("historico")){
        db.createObjectStore("historico", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = function(e){
      db = e.target.result;
      carregarHistorico();
    };
    request.onerror = function(){ console.error("Erro ao abrir IndexedDB"); };

    const form = document.getElementById('formCalc');
    const resultadoBox = document.getElementById('resultado');
    const custoPorKmEl = document.getElementById('custoPorKm');
    const custoViagemEl = document.getElementById('custoViagem');
    const lucroEl = document.getElementById('lucro');
    const tabelaHistorico = document.querySelector('#tabelaHistorico tbody');

    const resumosBox = document.getElementById('resumos');
    const totalViagensEl = document.getElementById('totalViagens');
    const totalBrutoEl = document.getElementById('totalBruto');
    const totalCustoEl = document.getElementById('totalCusto');
    const totalLucroEl = document.getElementById('totalLucro');

    function formatBRL(v){ return Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
    function toNumber(v){ return parseFloat(String(v).replace(',','.')); }

    form.addEventListener('submit', function(e){
      e.preventDefault();
      const litro = toNumber(document.getElementById('litro').value);
      const kmLitro = toNumber(document.getElementById('kmLitro').value);
      const kms = toNumber(document.getElementById('kmsRodados').value);
      const recebido = toNumber(document.getElementById('valorRecebido').value);
      if(!litro || !kmLitro || !kms || isNaN(recebido)){alert("Preencha todos os campos!");return;}

      const custoKm = litro / kmLitro;
      const custoViagem = custoKm * kms;
      const lucro = recebido - custoViagem;

      custoPorKmEl.textContent = formatBRL(custoKm.toFixed(2));
      custoViagemEl.textContent = formatBRL(custoViagem.toFixed(2));
      lucroEl.textContent = formatBRL(lucro.toFixed(2));
      lucroEl.className = lucro>0 ? "valor lucro-positivo" : (lucro<0 ? "valor lucro-negativo" : "valor");
      resultadoBox.style.display="block";

      salvarHistorico({litro, kmLitro, kms, recebido, custoKm: Number(custoKm.toFixed(2)), custoViagem: Number(custoViagem.toFixed(2)), lucro: Number(lucro.toFixed(2)), data:new Date().toLocaleString()});
    });

    document.getElementById('limpar').addEventListener('click', ()=>{form.reset();resultadoBox.style.display="none";});

    function salvarHistorico(obj){
      const tx = db.transaction("historico","readwrite");
      tx.objectStore("historico").add(obj);
      tx.oncomplete=carregarHistorico;
    }

    function carregarHistorico(){
      tabelaHistorico.innerHTML="";
      const tx = db.transaction("historico","readonly");
      const store = tx.objectStore("historico");
      const req = store.getAll();
      req.onsuccess = function(){
        let totalViagens=0, totalBruto=0, totalCusto=0, totalLucro=0;
        const dados = req.result;
        dados.forEach((d, index) => {
          totalViagens++;
          totalBruto += d.recebido;
          totalCusto += d.custoViagem;
          totalLucro += d.lucro;

          const lucroFormatado = formatBRL(Number(d.lucro).toFixed(2));
          const custoKmFormatado = formatBRL(Number(d.custoKm).toFixed(2));
          const custoViagemFormatado = formatBRL(Number(d.custoViagem).toFixed(2));

          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${index + 1}</td> <!-- Número da linha -->
            <td>${d.data}</td>
            <td>${formatBRL(d.litro)}</td>
            <td>${d.kmLitro}</td>
            <td>${d.kms}</td>
            <td>${formatBRL(d.recebido)}</td>
            <td>${custoKmFormatado}</td>
            <td>${custoViagemFormatado}</td>
            <td style="color:${d.lucro>=0?'green':'red'}">${lucroFormatado}</td>
            <td><button onclick="excluirRegistro(${d.id})">Excluir</button></td>
          `;
          tabelaHistorico.appendChild(tr);
        });

        totalViagensEl.textContent = totalViagens;
        totalBrutoEl.textContent = formatBRL(Number(totalBruto).toFixed(2));
        totalCustoEl.textContent = formatBRL(Number(totalCusto).toFixed(2));
        totalLucroEl.textContent = formatBRL(Number(totalLucro).toFixed(2));
        resumosBox.style.display = totalViagens>0 ? "block" : "none";
      };
    }

    function excluirRegistro(id){
      const tx = db.transaction("historico","readwrite");
      tx.objectStore("historico").delete(id);
      tx.oncomplete=carregarHistorico;
    }

    // Exportar JSON
    document.getElementById('exportar').addEventListener('click', ()=>{
      const tx = db.transaction("historico","readonly");
      const store = tx.objectStore("historico");
      const req = store.getAll();
      req.onsuccess=function(){
        const dados = JSON.stringify(req.result,null,2);
        const blob = new Blob([dados],{type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url;
        a.download="historico_combustivel.json";
        a.click();
        URL.revokeObjectURL(url);
      }
    });

    // Importar JSON
    const importarBtn = document.getElementById('importar');
    const fileInput = document.getElementById('fileInput');
    importarBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', function(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(event){
        try{
          const dados = JSON.parse(event.target.result);
          if(Array.isArray(dados)){
            const tx = db.transaction("historico","readwrite");
            const store = tx.objectStore("historico");
            dados.forEach(item=>{
              delete item.id;
              store.add(item);
            });
            tx.oncomplete=carregarHistorico;
          }else{
            alert("Arquivo inválido!");
          }
        }catch(err){
          alert("Erro ao importar JSON!");
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
